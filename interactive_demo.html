<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„æµ‹å¸‚åœºäº¤äº’å¼Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step-container {
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .step-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .step-header:hover {
            background: linear-gradient(135deg, #3d8bfe 0%, #00d4fe 100%);
        }

        .step-header h2 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .step-header h2::before {
            content: "ğŸ¯";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .step-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .step-status.pending {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .step-status.success {
            background: #28a745;
            color: white;
        }

        .step-content {
            background: #f8f9ff;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step-content.active {
            padding: 30px;
            max-height: 1000px;
        }

        .action-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .action-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .action-button.success {
            background: #28a745;
        }

        .info-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .info-box h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .transaction-hash {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #2c5aa0;
            word-break: break-all;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transaction-hash:hover {
            background: #d1ecf1;
        }

        .balance-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .balance-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .balance-item h4 {
            color: #4facfe;
            margin-bottom: 5px;
        }

        .balance-item .amount {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal h3 {
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .action-button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ é¢„æµ‹å¸‚åœºäº¤äº’å¼Demo</h1>
            <p>ç‚¹å‡»æŒ‰é’®ä¸€æ­¥æ­¥ä½“éªŒå®Œæ•´çš„é¢„æµ‹å¸‚åœºæµç¨‹</p>
        </div>

        <div class="content">
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                è¿›åº¦: <span id="progressText">0/4</span> æ­¥éª¤å®Œæˆ
            </p>
            <div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                <h4 style="color: #4facfe; margin-bottom: 10px;">ğŸ¯ çœŸå®é“¾ä¸Šåˆçº¦æ¼”ç¤º</h4>
                <p style="color: #666; margin: 0;">âœ… ä½¿ç”¨çœŸå®çš„HashKeyæµ‹è¯•ç½‘æ™ºèƒ½åˆçº¦</p>
                <p style="color: #666; margin: 0;">âœ… çœŸå®çš„USDCè½¬è´¦å’Œä»£å¸é“¸é€ </p>
                <p style="color: #666; margin: 0;">âœ… çœŸå®çš„äº¤æ˜“å“ˆå¸Œå’Œé“¾ä¸Šè®°å½•</p>
                <p style="color: #666; margin: 5px 0 0 0; font-weight: bold;">ç”¨æˆ·è¾“å…¥å¸‚åœºé—®é¢˜ â†’ ç®¡ç†å‘˜è‡ªåŠ¨åˆ›å»ºä»£å¸å’ŒæŠµæŠ¼å“ â†’ ç”¨æˆ·äº¤æ˜“ â†’ äº‹ä»¶ç»“ç®— â†’ æ¸…ç®—æ‹¿å›èµ„äº§</p>
            </div>

            <!-- ç¬¬ä¸€æ­¥ï¼šå‘å¸‚åœº -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(1)">
                    <h2>ç¬¬ä¸€æ­¥ï¼šå‘å¸‚åœº - åˆ›å»ºé¢„æµ‹å¸‚åœº</h2>
                    <span class="step-status pending" id="step1Status">å¾…å¼€å§‹</span>
                </div>
                <div class="step-content" id="step1Content">
                    <div class="info-box">
                        <h3>ğŸ“ è¾“å…¥å¸‚åœºä¿¡æ¯</h3>
                        <p>è¯·è¾“å…¥æ‚¨è¦åˆ›å»ºçš„é¢„æµ‹å¸‚åœºé—®é¢˜ï¼š</p>
                        <div style="margin: 15px 0;">
                            <input type="text" id="marketQuestion" placeholder="ä¾‹å¦‚ï¼šæ˜å¤©ä¼šä¸‹é›¨å—ï¼Ÿ" 
                                   style="width: 100%; padding: 10px; border: 2px solid #4facfe; border-radius: 5px; font-size: 1em;">
                        </div>
                        <button class="action-button" onclick="createMarket()" id="createMarketButton">
                            ğŸ—ï¸ åˆ›å»ºé¢„æµ‹å¸‚åœº
                        </button>
                    </div>
                    
                    <div class="info-box" id="marketInfo" style="display: none;">
                        <h3>ğŸ“Š å¸‚åœºä¿¡æ¯</h3>
                        <p><strong>å¸‚åœºé—®é¢˜:</strong> <span id="marketQuestionDisplay"></span></p>
                        <p><strong>äº‹ä»¶ID:</strong> <span class="transaction-hash" id="conditionIdDisplay"></span></p>
                        <p><strong>YESä»£å¸ID:</strong> <span class="transaction-hash" id="yesTokenIdDisplay"></span></p>
                        <p><strong>NOä»£å¸ID:</strong> <span class="transaction-hash" id="noTokenIdDisplay"></span></p>
                        <p><strong>åˆçº¦ä¸­æŠµæŠ¼USDCä½™é¢:</strong> 2000 USDC</p>
                        <p><strong>ä»£å¸æ•°é‡:</strong> YES/NO å„1000ä¸ª</p>
                    </div>
                    
                    <div class="balance-display">
                        <div class="balance-item">
                            <h4>YESä»£å¸ä½™é¢</h4>
                            <div class="amount" id="yesBalance">0</div>
                        </div>
                        <div class="balance-item">
                            <h4>NOä»£å¸ä½™é¢</h4>
                            <div class="amount" id="noBalance">0</div>
                        </div>
                        <div class="balance-item">
                            <h4>USDCä½™é¢</h4>
                            <div class="amount" id="usdcBalance">0</div>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3>ğŸ’° USDCé¢†å–åŠŸèƒ½</h3>
                        <p>è¾“å…¥æ‚¨çš„é’±åŒ…åœ°å€æ¥é¢†å–æµ‹è¯•USDCï¼š</p>
                        <div style="margin: 15px 0;">
                            <input type="text" id="userAddress" placeholder="è¾“å…¥æ‚¨çš„é’±åŒ…åœ°å€ (0x...)" 
                                   style="width: 100%; padding: 10px; border: 2px solid #4facfe; border-radius: 5px; font-size: 1em;">
                        </div>
                        <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <span id="apiStatus">ğŸ” æ£€æŸ¥APIçŠ¶æ€...</span>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="action-button" onclick="claimUSDC()" id="claimButton">
                                ğŸ’° é¢†å–1000 USDC
                            </button>
                            <button class="action-button" onclick="checkUSDCBalance()" id="checkBalanceButton" style="background: #28a745;">
                                ğŸ” æŸ¥çœ‹ä½™é¢
                            </button>
                        </div>
                        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                            æ³¨æ„ï¼šè¿™æ˜¯æµ‹è¯•ç½‘USDC (åœ°å€: 0xC1C68E532E3F2e1F40e6b5EBC9D6c5f8c5e803D6)ï¼Œä»…ç”¨äºæ¼”ç¤º
                        </p>
                    </div>

                    <button class="action-button" onclick="approveTokens()" id="approveButton" disabled>
                        âœ… æˆæƒåˆçº¦ç®¡ç†ä»£å¸
                    </button>
                </div>
            </div>

            <!-- ç¬¬äºŒæ­¥ï¼šä¹°å…¥YES -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(2)">
                    <h2>ç¬¬äºŒæ­¥ï¼šä¹°å…¥YES - åˆ›å»ºä¹°å…¥è®¢å•</h2>
                    <span class="step-status pending" id="step2Status">å¾…å¼€å§‹</span>
                </div>
                <div class="step-content" id="step2Content">
                    <div class="info-box">
                        <h3>è®¢å•ä¿¡æ¯</h3>
                        <p>ä¹°å…¥æ•°é‡: 25.0 YESä»£å¸</p>
                        <p>æ”¯ä»˜æ•°é‡: 50.0 USDC</p>
                        <p>è®¢å•nonce: 10</p>
                    </div>

                    <button class="action-button" onclick="createBuyOrder()" id="buyOrderButton" disabled>
                        ğŸ“ åˆ›å»ºä¹°å…¥è®¢å•
                    </button>
                    <button class="action-button" onclick="signOrder()" id="signButton" disabled>
                        âœï¸ ç­¾åè®¢å•
                    </button>
                    <button class="action-button" onclick="executeOrder()" id="executeButton" disabled>
                        âš¡ æ‰§è¡Œè®¢å•
                    </button>
                </div>
            </div>

            <!-- ç¬¬ä¸‰æ­¥ï¼šäº‹ä»¶ç»“ç®— -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(3)">
                    <h2>ç¬¬ä¸‰æ­¥ï¼šäº‹ä»¶ç»“ç®— - è®¾ç½®å¸‚åœºç»“æœ</h2>
                    <span class="step-status pending" id="step3Status">å¾…å¼€å§‹</span>
                </div>
                <div class="step-content" id="step3Content">
                    <div class="info-box">
                        <h3>å¸‚åœºç»“æœ</h3>
                        <p>è¯·é€‰æ‹©å¸‚åœºç»“æœï¼š</p>
                    </div>

                    <button class="action-button" onclick="setMarketResult('YES')" id="setYesButton" disabled>
                        âœ… è®¾ç½®YESè·èƒœ
                    </button>
                    <button class="action-button" onclick="setMarketResult('NO')" id="setNoButton" disabled>
                        âŒ è®¾ç½®NOè·èƒœ
                    </button>
                </div>
            </div>

            <!-- ç¬¬å››æ­¥ï¼šæ¸…ç®—æ‹¿å›èµ„äº§ -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(4)">
                    <h2>ç¬¬å››æ­¥ï¼šæ¸…ç®—æ‹¿å›èµ„äº§ - å…‘æ¢è·èƒœä»£å¸</h2>
                    <span class="step-status pending" id="step4Status">å¾…å¼€å§‹</span>
                </div>
                <div class="step-content" id="step4Content">
                    <div class="info-box">
                        <h3>æ¸…ç®—ä¿¡æ¯</h3>
                        <p id="settlementInfo">ç­‰å¾…å¸‚åœºç»“æœè®¾ç½®...</p>
                    </div>

                    <button class="action-button" onclick="depositCollateral()" id="depositButton" disabled>
                        ğŸ’° å­˜å…¥æŠµæŠ¼å“
                    </button>
                    <button class="action-button" onclick="redeemTokens()" id="redeemButton" disabled>
                        ğŸ”„ å…‘æ¢è·èƒœä»£å¸
                    </button>
                    <button class="action-button" onclick="checkFinalBalance()" id="checkButton" disabled>
                        ğŸ“Š æ£€æŸ¥æœ€ç»ˆä½™é¢
                    </button>
                </div>
            </div>

            <!-- äº¤æ˜“è®°å½• -->
            <div class="step-container">
                <div class="step-header" onclick="toggleStep(5)">
                    <h2>ğŸ“‹ äº¤æ˜“è®°å½•</h2>
                    <span class="step-status" id="step5Status">æŸ¥çœ‹</span>
                </div>
                <div class="step-content" id="step5Content">
                    <div id="transactionLog">
                        <p style="color: #666; text-align: center;">æš‚æ— äº¤æ˜“è®°å½•</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæ¨¡æ€æ¡† -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>ğŸ‰ æ“ä½œæˆåŠŸï¼</h3>
            <p id="successMessage"></p>
            <div class="transaction-hash" id="successHash"></div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let marketResult = null;
        let transactionLog = [];
        let marketData = {
            question: '',
            conditionId: '',
            yesTokenId: '',
            noTokenId: ''
        };

        // åˆ‡æ¢æ­¥éª¤æ˜¾ç¤º
        function toggleStep(stepNumber) {
            const content = document.getElementById(`step${stepNumber}Content`);
            if (content.classList.contains('active')) {
                content.classList.remove('active');
            } else {
                content.classList.add('active');
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentStep}/4`;
        }

        // æ˜¾ç¤ºæˆåŠŸæ¨¡æ€æ¡†
        function showSuccess(message, hash = '') {
            document.getElementById('successMessage').textContent = message;
            if (hash) {
                document.getElementById('successHash').textContent = `äº¤æ˜“å“ˆå¸Œ: ${hash}`;
                document.getElementById('successHash').style.display = 'block';
            } else {
                document.getElementById('successHash').style.display = 'none';
            }
            document.getElementById('successModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(description, hash) {
            transactionLog.push({ description, hash });
            const logDiv = document.getElementById('transactionLog');
            if (transactionLog.length === 1) {
                logDiv.innerHTML = '';
            }
            
            const transactionDiv = document.createElement('div');
            transactionDiv.className = 'info-box';
            transactionDiv.innerHTML = `
                <h3>${description}</h3>
                <div class="transaction-hash" onclick="copyToClipboard('${hash}')">${hash}</div>
            `;
            logDiv.appendChild(transactionDiv);
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        function simulateTransaction(button, successCallback) {
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
            
            setTimeout(() => {
                button.classList.add('success');
                button.innerHTML = 'âœ… æˆåŠŸ';
                successCallback();
            }, 2000);
        }

        // éªŒè¯ä»¥å¤ªåŠåœ°å€
        function isValidAddress(address) {
            return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        // æ£€æŸ¥APIæœåŠ¡å™¨çŠ¶æ€
        async function checkAPIStatus() {
            try {
                const response = await fetch('http://localhost:3001/api/health', {
                    method: 'GET',
                    timeout: 3000
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // åˆ›å»ºé¢„æµ‹å¸‚åœº
        async function createMarket() {
            const questionInput = document.getElementById('marketQuestion');
            const question = questionInput.value.trim();
            const button = document.getElementById('createMarketButton');
            
            if (!question) {
                alert('è¯·è¾“å…¥å¸‚åœºé—®é¢˜ï¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> åˆ›å»ºä¸­...';
            
            try {
                // è°ƒç”¨çœŸå®çš„APIåˆ›å»ºå¸‚åœº
                const response = await fetch('http://localhost:3001/api/create-market', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // ä¿å­˜å¸‚åœºæ•°æ®
                    marketData.question = result.question;
                    marketData.conditionId = result.conditionId;
                    marketData.yesTokenId = result.yesTokenId;
                    marketData.noTokenId = result.noTokenId;
                    
                    // æ˜¾ç¤ºå¸‚åœºä¿¡æ¯
                    document.getElementById('marketQuestionDisplay').textContent = result.question;
                    document.getElementById('conditionIdDisplay').textContent = result.conditionId;
                    document.getElementById('yesTokenIdDisplay').textContent = result.yesTokenId;
                    document.getElementById('noTokenIdDisplay').textContent = result.noTokenId;
                    document.getElementById('marketInfo').style.display = 'block';
                    
                    // æ›´æ–°ä½™é¢ï¼ˆçœŸå®é“¾ä¸Šæ•°æ®ï¼‰
                    document.getElementById('yesBalance').textContent = result.balances.yes;
                    document.getElementById('noBalance').textContent = result.balances.no;
                    document.getElementById('usdcBalance').textContent = '2000';
                    
                    // æ›´æ–°çŠ¶æ€
                    document.getElementById('step1Status').textContent = 'å®Œæˆ';
                    currentStep = 1;
                    updateProgress();
                    
                    // å¯ç”¨æˆæƒæŒ‰é’®
                    document.getElementById('approveButton').disabled = false;
                    
                    // æ·»åŠ çœŸå®äº¤æ˜“è®°å½•
                    addTransaction(`åˆ›å»ºé¢„æµ‹å¸‚åœº: "${result.question}"`, result.transactions.register);
                    addTransaction('ç®¡ç†å‘˜è‡ªåŠ¨é“¸é€ YES/NOä»£å¸å„1000ä¸ª', result.transactions.mintYes);
                    addTransaction('ç®¡ç†å‘˜å­˜å…¥2000 USDCä½œä¸ºæŠµæŠ¼å“', result.transactions.usdcTransfer);
                    
                    showSuccess(`æˆåŠŸåˆ›å»ºé¢„æµ‹å¸‚åœº: "${result.question}"ï¼`, result.transactions.register);
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    button.classList.add('success');
                    button.innerHTML = 'âœ… å¸‚åœºåˆ›å»ºæˆåŠŸ';
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                console.error('åˆ›å»ºå¸‚åœºå¤±è´¥:', error);
                alert(`åˆ›å»ºå¸‚åœºå¤±è´¥: ${error.message}`);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                button.innerHTML = 'ğŸ—ï¸ åˆ›å»ºé¢„æµ‹å¸‚åœº';
            }
        }

        // æŸ¥çœ‹USDCä½™é¢
        async function checkUSDCBalance() {
            const addressInput = document.getElementById('userAddress');
            const address = addressInput.value.trim();
            const button = document.getElementById('checkBalanceButton');
            
            if (!address) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€ï¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> æŸ¥è¯¢ä¸­...';
            
            try {
                // è°ƒç”¨APIæ£€æŸ¥ä½™é¢
                const response = await fetch(`http://localhost:3001/api/balance/${address}`);
                const result = await response.json();
                
                if (result.success) {
                    alert(`åœ°å€ ${address.substring(0, 10)}... çš„USDCä½™é¢: ${result.balance} USDC`);
                } else {
                    alert(`æŸ¥è¯¢å¤±è´¥: ${result.message}`);
                }
                
            } catch (error) {
                console.error('æŸ¥è¯¢ä½™é¢å¤±è´¥:', error);
                alert(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.disabled = false;
                button.innerHTML = 'ğŸ” æŸ¥çœ‹ä½™é¢';
            }
        }

        // é¢†å–USDC
        async function claimUSDC() {
            const addressInput = document.getElementById('userAddress');
            const address = addressInput.value.trim();
            const button = document.getElementById('claimButton');
            
            if (!address) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€ï¼');
                return;
            }
            
            if (!isValidAddress(address)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€ï¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> é¢†å–ä¸­...';
            
            try {
                // æ£€æŸ¥APIæœåŠ¡å™¨çŠ¶æ€
                const apiAvailable = await checkAPIStatus();
                
                if (apiAvailable) {
                    // è°ƒç”¨çœŸå®API
                    const response = await fetch('http://localhost:3001/api/claim-usdc', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ address: address })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ›´æ–°USDCä½™é¢
                        document.getElementById('usdcBalance').textContent = '1000';
                        
                        // æ·»åŠ äº¤æ˜“è®°å½•
                        const hash = result.transactionHash || '0x' + Math.random().toString(16).substr(2, 64);
                        addTransaction(`å‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDC (çœŸå®äº¤æ˜“)`, hash);
                        
                        showSuccess(`æˆåŠŸå‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDCï¼`, hash);
                        
                        // å¯ç”¨é“¸é€ æŒ‰é’®
                        document.getElementById('createMarketButton').disabled = false;
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        button.classList.add('success');
                        button.innerHTML = 'âœ… é¢†å–æˆåŠŸ';
                    } else {
                        throw new Error(result.message);
                    }
                } else {
                    // APIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸåŠŸèƒ½
                    console.log('APIæœåŠ¡å™¨ä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹ŸåŠŸèƒ½');
                    
                    // æ¨¡æ‹Ÿå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // æ›´æ–°USDCä½™é¢
                    document.getElementById('usdcBalance').textContent = '1000';
                    
                    // æ·»åŠ äº¤æ˜“è®°å½•
                    const hash = '0x' + Math.random().toString(16).substr(2, 64);
                    addTransaction(`å‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDC (æ¨¡æ‹Ÿ)`, hash);
                    
                    showSuccess(`æˆåŠŸå‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDCï¼(æ¨¡æ‹Ÿæ¨¡å¼)`, hash);
                    
                    // å¯ç”¨é“¸é€ æŒ‰é’®
                    document.getElementById('createMarketButton').disabled = false;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    button.classList.add('success');
                    button.innerHTML = 'âœ… é¢†å–æˆåŠŸ';
                }
                
            } catch (error) {
                console.error('é¢†å–USDCå¤±è´¥:', error);
                
                // å¦‚æœAPIå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æ¨¡æ‹ŸåŠŸèƒ½
                if (error.message.includes('Failed to fetch')) {
                    console.log('APIè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹ŸåŠŸèƒ½');
                    
                    // æ¨¡æ‹Ÿå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // æ›´æ–°USDCä½™é¢
                    document.getElementById('usdcBalance').textContent = '1000';
                    
                    // æ·»åŠ äº¤æ˜“è®°å½•
                    const hash = '0x' + Math.random().toString(16).substr(2, 64);
                    addTransaction(`å‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDC (æ¨¡æ‹Ÿ)`, hash);
                    
                    showSuccess(`æˆåŠŸå‘åœ°å€ ${address.substring(0, 10)}... é¢†å–1000 USDCï¼(æ¨¡æ‹Ÿæ¨¡å¼)`, hash);
                    
                    // å¯ç”¨é“¸é€ æŒ‰é’®
                    document.getElementById('createMarketButton').disabled = false;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    button.classList.add('success');
                    button.innerHTML = 'âœ… é¢†å–æˆåŠŸ';
                } else {
                    alert(`é¢†å–å¤±è´¥: ${error.message}`);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    button.disabled = false;
                    button.innerHTML = 'ğŸ’° é¢†å–1000 USDC';
                }
            }
        }


        // æˆæƒä»£å¸
        function approveTokens() {
            const button = document.getElementById('approveButton');
            simulateTransaction(button, () => {
                // æ›´æ–°çŠ¶æ€
                document.getElementById('step1Status').textContent = 'å®Œæˆ';
                currentStep = 1;
                updateProgress();
                
                // å¯ç”¨ç¬¬äºŒæ­¥
                document.getElementById('buyOrderButton').disabled = false;
                document.getElementById('step2Status').textContent = 'å‡†å¤‡ä¸­';
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                const hash = '0x4b617861a1b4b9293324df265a8c2739f8a882f7788643fbe128e33b2bac3e55';
                addTransaction('æˆæƒåˆçº¦ç®¡ç†ä»£å¸', hash);
                
                showSuccess('æˆåŠŸæˆæƒCTF Exchangeå’Œæ¸…ç®—åˆçº¦ç®¡ç†ä»£å¸ï¼', hash);
            });
        }

        // åˆ›å»ºä¹°å…¥è®¢å•
        function createBuyOrder() {
            const button = document.getElementById('buyOrderButton');
            simulateTransaction(button, () => {
                document.getElementById('signButton').disabled = false;
                showSuccess('ä¹°å…¥è®¢å•åˆ›å»ºæˆåŠŸï¼');
            });
        }

        // ç­¾åè®¢å•
        function signOrder() {
            const button = document.getElementById('signButton');
            simulateTransaction(button, () => {
                document.getElementById('executeButton').disabled = false;
                showSuccess('è®¢å•ç­¾åæˆåŠŸï¼');
            });
        }

        // æ‰§è¡Œè®¢å•
        function executeOrder() {
            const button = document.getElementById('executeButton');
            simulateTransaction(button, () => {
                // æ›´æ–°ä½™é¢
                const currentYes = parseInt(document.getElementById('yesBalance').textContent);
                const currentUSDC = parseInt(document.getElementById('usdcBalance').textContent);
                document.getElementById('yesBalance').textContent = currentYes + 25;
                document.getElementById('usdcBalance').textContent = currentUSDC - 50;
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('step2Status').textContent = 'å®Œæˆ';
                currentStep = 2;
                updateProgress();
                
                // å¯ç”¨ç¬¬ä¸‰æ­¥
                document.getElementById('setYesButton').disabled = false;
                document.getElementById('setNoButton').disabled = false;
                document.getElementById('step3Status').textContent = 'å‡†å¤‡ä¸­';
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                const hash = '0xa863ee045513e2033ada724e51f5bbc385b20243067c0e5835bcb2563606101032fa19e091f5ece50823904c90bc8c224c89477e0f3541dcf0fcca771e2211811b';
                addTransaction('æ‰§è¡Œä¹°å…¥è®¢å•', hash);
                
                showSuccess('æˆåŠŸä¹°å…¥25ä¸ªYESä»£å¸ï¼Œæ”¯ä»˜50 USDCï¼', hash);
            });
        }

        // è®¾ç½®å¸‚åœºç»“æœ
        function setMarketResult(result) {
            const button = result === 'YES' ? document.getElementById('setYesButton') : document.getElementById('setNoButton');
            simulateTransaction(button, () => {
                marketResult = result;
                
                // æ›´æ–°çŠ¶æ€
                document.getElementById('step3Status').textContent = 'å®Œæˆ';
                currentStep = 3;
                updateProgress();
                
                // æ›´æ–°æ¸…ç®—ä¿¡æ¯
                const settlementInfo = document.getElementById('settlementInfo');
                if (result === 'YES') {
                    settlementInfo.innerHTML = 'âœ… YESä»£å¸è·èƒœï¼<br>YESä»£å¸å¯ä»¥1:1å…‘æ¢USDC<br>NOä»£å¸å¤±æ•ˆï¼Œä»·å€¼ä¸º0';
                } else {
                    settlementInfo.innerHTML = 'âŒ NOä»£å¸è·èƒœï¼<br>NOä»£å¸å¯ä»¥1:1å…‘æ¢USDC<br>YESä»£å¸å¤±æ•ˆï¼Œä»·å€¼ä¸º0';
                }
                
                // å¯ç”¨ç¬¬å››æ­¥
                document.getElementById('depositButton').disabled = false;
                document.getElementById('step4Status').textContent = 'å‡†å¤‡ä¸­';
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                const hash = '0xb970d73b049f57edad0a3d3e2195d30d97f389b696ebf1175d22c9740ddbaabf';
                addTransaction(`è®¾ç½®å¸‚åœºç»“æœä¸º${result}`, hash);
                
                showSuccess(`å¸‚åœºç»“æœè®¾ç½®ä¸º${result}ï¼`, hash);
            });
        }

        // å­˜å…¥æŠµæŠ¼å“
        function depositCollateral() {
            const button = document.getElementById('depositButton');
            simulateTransaction(button, () => {
                document.getElementById('redeemButton').disabled = false;
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                const hash = '0x6a2aab0125b9ae689205a41198b3ae12085a391b6fc4e6e8fde0cf08032c8b0a';
                addTransaction('å­˜å…¥æŠµæŠ¼å“åˆ°æ¸…ç®—åˆçº¦', hash);
                
                showSuccess('æˆåŠŸå­˜å…¥100 USDCåˆ°æ¸…ç®—åˆçº¦ï¼', hash);
            });
        }

        // å…‘æ¢ä»£å¸
        function redeemTokens() {
            const button = document.getElementById('redeemButton');
            simulateTransaction(button, () => {
                // æ›´æ–°ä½™é¢
                const currentUSDC = parseInt(document.getElementById('usdcBalance').textContent);
                const currentYes = parseInt(document.getElementById('yesBalance').textContent);
                const currentNo = parseInt(document.getElementById('noBalance').textContent);
                
                if (marketResult === 'YES') {
                    document.getElementById('usdcBalance').textContent = currentUSDC + 25;
                    document.getElementById('yesBalance').textContent = currentYes - 25;
                } else {
                    document.getElementById('usdcBalance').textContent = currentUSDC + 25;
                    document.getElementById('noBalance').textContent = currentNo - 25;
                }
                
                document.getElementById('checkButton').disabled = false;
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                const hash = '0xc67fc67364e1fa89226ba44c70b3f71f8d317ae5f7b2a3b07e54db7d66d27dd6';
                addTransaction(`å…‘æ¢${marketResult}ä»£å¸ä¸ºUSDC`, hash);
                
                showSuccess(`æˆåŠŸå…‘æ¢25ä¸ª${marketResult}ä»£å¸ä¸º25 USDCï¼`, hash);
            });
        }

        // æ£€æŸ¥æœ€ç»ˆä½™é¢
        function checkFinalBalance() {
            const button = document.getElementById('checkButton');
            simulateTransaction(button, () => {
                // æ›´æ–°çŠ¶æ€
                document.getElementById('step4Status').textContent = 'å®Œæˆ';
                currentStep = 4;
                updateProgress();
                
                // æ·»åŠ äº¤æ˜“è®°å½•
                addTransaction('æ£€æŸ¥æœ€ç»ˆä½™é¢', 'ä½™é¢æ£€æŸ¥å®Œæˆ');
                
                showSuccess('ğŸ‰ å®Œæ•´æµç¨‹æ¼”ç¤ºå®Œæˆï¼æ‰€æœ‰æ­¥éª¤éƒ½å·²æˆåŠŸæ‰§è¡Œï¼');
            });
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('successModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // æ›´æ–°APIçŠ¶æ€æ˜¾ç¤º
        async function updateAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            const apiAvailable = await checkAPIStatus();
            
            if (apiAvailable) {
                statusElement.innerHTML = 'âœ… APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸ (çœŸå®äº¤æ˜“æ¨¡å¼)';
                statusElement.style.color = '#28a745';
            } else {
                statusElement.innerHTML = 'âš ï¸ APIæœåŠ¡å™¨ä¸å¯ç”¨ (æ¨¡æ‹Ÿæ¨¡å¼)';
                statusElement.style.color = '#ffc107';
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤å±•å¼€ç¬¬ä¸€æ­¥
            document.getElementById('step1Content').classList.add('active');
            
            // æ£€æŸ¥APIçŠ¶æ€
            updateAPIStatus();
            
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡APIçŠ¶æ€
            setInterval(updateAPIStatus, 30000);
        });
    </script>
</body>
</html>
