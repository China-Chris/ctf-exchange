<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„æµ‹å¸‚åœºå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@rainbow-me/rainbowkit@1.3.0/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wagmi@1.4.0/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/viem@1.19.0/dist/index.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            text-align: center;
            color: #4facfe;
            margin-bottom: 20px;
            font-size: 2.5em;
        }

        .login-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .login-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 200px;
        }

        .login-card h3 {
            color: #4facfe;
            margin-bottom: 15px;
        }

        .login-card input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }

        .login-card button {
            width: 100%;
            padding: 12px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-card button:hover {
            background: #3d8bfe;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .user-info.active {
            display: block;
        }

        .user-info h3 {
            color: #4facfe;
            margin-bottom: 10px;
        }

        .balance-display {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }

        .balance-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            flex: 1;
        }

        .balance-item h4 {
            color: #666;
            margin-bottom: 5px;
        }

        .balance-item .amount {
            font-size: 1.2em;
            font-weight: bold;
            color: #4facfe;
        }

        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 1em;
            transition: background 0.3s;
        }

        .tab.active {
            background: #4facfe;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .market-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .market-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #4facfe;
        }

        .market-item h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .market-item p {
            color: #666;
            margin-bottom: 15px;
        }

        .market-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .label {
            color: #666;
            font-size: 0.9em;
        }

        .stat-item .value {
            font-weight: bold;
            color: #4facfe;
        }

        .market-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .admin-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-panel h3 {
            color: #4facfe;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1em;
            resize: vertical;
            min-height: 100px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .transaction-log {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .trading-interface {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .trading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .trading-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .trading-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .trading-section:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .trading-section h4 {
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .price-info {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #495057;
        }

        .trading-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-outline-success {
            background: transparent;
            color: #28a745;
            border: 2px solid #28a745;
        }

        .btn-outline-success:hover {
            background: #28a745;
            color: white;
        }

        .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 2px solid #dc3545;
        }

        .btn-outline-danger:hover {
            background: #dc3545;
            color: white;
        }

        .trading-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 15px;
        }

        .trading-row {
            display: flex;
            gap: 8px;
            justify-content: space-between;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¯ é¢„æµ‹å¸‚åœºå¹³å°</h1>
            <div class="wallet-section">
                <div id="rainbowkit-connect-button"></div>
            </div>
        </div>


        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content" id="mainContent">
            <!-- å¸‚åœºåˆ—è¡¨ -->
            <div class="market-list">
                <h2>ğŸ“Š é¢„æµ‹å¸‚åœº</h2>
                <div id="marketList">
                    <!-- å¸‚åœºåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
                </div>
            </div>


        </div>

        <!-- äº¤æ˜“è®°å½• -->
        <div class="transaction-log" id="transactionLog">
            <h4>ğŸ“ äº¤æ˜“è®°å½•</h4>
            <div id="transactionList">
                <!-- äº¤æ˜“è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentUserType = null;
        let markets = [];
        let selectedMarket = null;
        let provider = null;
        let signer = null;
        let wagmiClient = null;
        let rainbowKit = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³æ˜¾ç¤ºå¸‚åœºåˆ—è¡¨
            loadMarkets();
            setInterval(loadMarkets, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡å¸‚åœºåˆ—è¡¨
            
            // åˆå§‹åŒ–RainbowKit
            initializeRainbowKit();
            
            // æ˜¾ç¤ºä¸»è¦å†…å®¹
            document.getElementById('mainContent').classList.add('active');
        });

        // æ£€æŸ¥å¹¶åˆ‡æ¢åˆ°HashKeyæµ‹è¯•ç½‘
        async function checkAndSwitchNetwork() {
            try {
                if (!window.ethereum) return;
                
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const hashkeyChainId = '0x85'; // 133 in hex
                
                if (chainId !== hashkeyChainId) {
                    console.log('å½“å‰ç½‘ç»œID:', chainId, 'éœ€è¦åˆ‡æ¢åˆ°:', hashkeyChainId);
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: hashkeyChainId }],
                        });
                        console.log('å·²åˆ‡æ¢åˆ°HashKeyæµ‹è¯•ç½‘');
                    } catch (switchError) {
                        // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œå°è¯•æ·»åŠ ç½‘ç»œ
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: hashkeyChainId,
                                        chainName: 'HashKey Testnet',
                                        nativeCurrency: {
                                            name: 'HSK',
                                            symbol: 'HSK',
                                            decimals: 18,
                                        },
                                        rpcUrls: ['https://testnet.hsk.xyz'],
                                        blockExplorerUrls: ['https://testnet.hsk.xyz'],
                                    }],
                                });
                                console.log('å·²æ·»åŠ å¹¶åˆ‡æ¢åˆ°HashKeyæµ‹è¯•ç½‘');
                            } catch (addError) {
                                console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', addError);
                                alert('è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°HashKeyæµ‹è¯•ç½‘ (Chain ID: 133)');
                            }
                        } else {
                            console.error('åˆ‡æ¢ç½‘ç»œå¤±è´¥:', switchError);
                            alert('è¯·æ‰‹åŠ¨åˆ‡æ¢åˆ°HashKeyæµ‹è¯•ç½‘ (Chain ID: 133)');
                        }
                    }
                } else {
                    console.log('å·²åœ¨HashKeyæµ‹è¯•ç½‘ä¸Š');
                }
            } catch (error) {
                console.error('ç½‘ç»œæ£€æŸ¥å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–RainbowKit
        async function initializeRainbowKit() {
            try {
                // é…ç½®HashKeyæµ‹è¯•ç½‘
                const hashkeyTestnet = {
                    id: 133,
                    name: 'HashKey Testnet',
                    network: 'hashkey-testnet',
                    nativeCurrency: {
                        decimals: 18,
                        name: 'HSK',
                        symbol: 'HSK',
                    },
                    rpcUrls: {
                        public: { http: ['https://testnet.hsk.xyz'] },
                        default: { http: ['https://testnet.hsk.xyz'] },
                    },
                    blockExplorers: {
                        default: { name: 'HashKey Explorer', url: 'https://testnet.hsk.xyz' },
                    },
                    testnet: true,
                };

                // åˆ›å»ºWagmiå®¢æˆ·ç«¯
                wagmiClient = wagmi.createConfig({
                    chains: [hashkeyTestnet],
                    transports: {
                        [hashkeyTestnet.id]: wagmi.http('https://testnet.hsk.xyz'),
                    },
                });

                // åˆå§‹åŒ–RainbowKit
                rainbowKit = RainbowKit.initialize({
                    client: wagmiClient,
                    chains: [hashkeyTestnet],
                    appName: 'é¢„æµ‹å¸‚åœºå¹³å°',
                    appDescription: 'åŸºäºCTF Exchangeçš„é¢„æµ‹å¸‚åœºå¹³å°',
                    appUrl: window.location.origin,
                    appIcon: 'ğŸ¯',
                });

                // æ¸²æŸ“è¿æ¥æŒ‰é’®
                rainbowKit.mount('#rainbowkit-connect-button');

                // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
                wagmiClient.subscribe((state) => {
                    if (state.status === 'connected') {
                        currentUser = state.accounts[0];
                        currentUserType = 'user';
                        provider = new ethers.BrowserProvider(window.ethereum);
                        
                        // æ£€æŸ¥ç½‘ç»œæ˜¯å¦æ­£ç¡®
                        checkAndSwitchNetwork();
                        
                        updateUserBalance();
                        addTransaction('RainbowKité’±åŒ…è¿æ¥', `åœ°å€: ${currentUser.substring(0, 10)}...`);
                    } else if (state.status === 'disconnected') {
                        currentUser = null;
                        currentUserType = null;
                        provider = null;
                        signer = null;
                        addTransaction('æ–­å¼€é’±åŒ…è¿æ¥', 'ç”¨æˆ·å·²æ–­å¼€è¿æ¥');
                    }
                });

                console.log('RainbowKitåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('RainbowKitåˆå§‹åŒ–å¤±è´¥:', error);
                // é™çº§åˆ°ç®€å•çš„è¿æ¥æŒ‰é’®
                createFallbackConnectButton();
            }
        }

        // åˆ›å»ºé™çº§è¿æ¥æŒ‰é’®
        function createFallbackConnectButton() {
            const connectButton = document.getElementById('rainbowkit-connect-button');
            connectButton.innerHTML = `
                <button onclick="connectWalletFallback()" class="btn btn-primary">
                    ğŸ”— è¿æ¥é’±åŒ…
                </button>
            `;
        }

        // é™çº§è¿æ¥é’±åŒ…å‡½æ•°
        async function connectWalletFallback() {
            if (typeof window.ethereum === 'undefined') {
                alert('è¯·å®‰è£…MetaMaskæˆ–å…¶ä»–Web3é’±åŒ…ï¼');
                return;
            }

            try {
                // è¯·æ±‚è¿æ¥é’±åŒ…
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                if (accounts.length > 0) {
                    // åˆ›å»ºproviderå’Œsigner
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    currentUser = accounts[0];
                    currentUserType = 'user';

                    // æ£€æŸ¥å¹¶åˆ‡æ¢ç½‘ç»œ
                    await checkAndSwitchNetwork();

                    // æ›´æ–°UI
                    const connectButton = document.getElementById('rainbowkit-connect-button');
                    connectButton.innerHTML = `
                        <div class="wallet-info">
                            <span>${currentUser.substring(0, 6)}...${currentUser.substring(38)}</span>
                            <button onclick="disconnectWalletFallback()" class="btn btn-sm btn-danger">æ–­å¼€</button>
                        </div>
                    `;

                    await updateUserBalance();
                    addTransaction('é’±åŒ…è¿æ¥', `åœ°å€: ${currentUser.substring(0, 10)}...`);

                    // ç›‘å¬è´¦æˆ·å˜åŒ–
                    window.ethereum.on('accountsChanged', handleAccountsChanged);
                    window.ethereum.on('chainChanged', handleChainChanged);
                }
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                alert('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
            }
        }

        // é™çº§æ–­å¼€é’±åŒ…å‡½æ•°
        function disconnectWalletFallback() {
            currentUser = null;
            currentUserType = null;
            provider = null;
            signer = null;

            // æ›´æ–°UI
            const connectButton = document.getElementById('rainbowkit-connect-button');
            connectButton.innerHTML = `
                <button onclick="connectWalletFallback()" class="btn btn-primary">
                    ğŸ”— è¿æ¥é’±åŒ…
                </button>
            `;

            addTransaction('æ–­å¼€é’±åŒ…è¿æ¥', 'ç”¨æˆ·å·²æ–­å¼€è¿æ¥');
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                if (rainbowKit) {
                    // RainbowKitæ¨¡å¼
                    currentUser = null;
                    currentUserType = null;
                    provider = null;
                    signer = null;
                    addTransaction('æ–­å¼€é’±åŒ…è¿æ¥', 'ç”¨æˆ·å·²æ–­å¼€è¿æ¥');
                } else {
                    // é™çº§æ¨¡å¼
                    disconnectWalletFallback();
                }
            } else {
                location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥æ›´æ–°è´¦æˆ·
            }
        }

        // å¤„ç†ç½‘ç»œå˜åŒ–
        function handleChainChanged(chainId) {
            location.reload(); // é‡æ–°åŠ è½½é¡µé¢ä»¥æ›´æ–°ç½‘ç»œ
        }





        // åŠ è½½å¸‚åœºåˆ—è¡¨
        async function loadMarkets() {
            try {
                const response = await fetch('http://localhost:3001/api/markets');
                const result = await response.json();
                
                if (result.success) {
                    markets = result.markets;
                    displayMarkets();
                } else {
                    console.error('åŠ è½½å¸‚åœºå¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºå¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºå¸‚åœºåˆ—è¡¨
        function displayMarkets() {
            const marketList = document.getElementById('marketList');
            
            if (markets.length === 0) {
                marketList.innerHTML = '<p>æš‚æ— æ´»è·ƒå¸‚åœº</p>';
                return;
            }
            
            marketList.innerHTML = markets.map(market => `
                <div class="market-item">
                    <h3>${market.question}</h3>
                    <p>çŠ¶æ€: ${market.status === 'active' ? 'ğŸŸ¢ æ´»è·ƒ' : 'ğŸ”´ å·²ç»“æŸ'}</p>
                    <div class="market-stats">
                        <div class="stat-item">
                            <div class="label">YESä»£å¸</div>
                            <div class="value">${market.balances.yes}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">NOä»£å¸</div>
                            <div class="value">${market.balances.no}</div>
                        </div>
                        <div class="stat-item">
                            <div class="label">åˆ›å»ºæ—¶é—´</div>
                            <div class="value">${new Date(market.createdAt).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="market-actions">
                        <div class="trading-buttons">
                            <div class="trading-row">
                                <button class="btn btn-success btn-sm" onclick="buyTokens('${market.id}', 'YES')">ğŸŸ¢ ä¹°å…¥YES</button>
                                <button class="btn btn-outline-success btn-sm" onclick="sellTokens('${market.id}', 'YES')">ğŸŸ¢ å–å‡ºYES</button>
                            </div>
                            <div class="trading-row">
                                <button class="btn btn-danger btn-sm" onclick="buyTokens('${market.id}', 'NO')">ğŸ”´ ä¹°å…¥NO</button>
                                <button class="btn btn-outline-danger btn-sm" onclick="sellTokens('${market.id}', 'NO')">ğŸ”´ å–å‡ºNO</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }




        // ä¹°å…¥ä»£å¸
        async function buyTokens(marketId, tokenType) {
            if (!currentUser) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
                return;
            }
            
            const market = markets.find(m => m.id === marketId);
            if (!market) {
                alert('å¸‚åœºä¸å­˜åœ¨ï¼');
                return;
            }
            
            const amount = prompt(`è¯·è¾“å…¥è¦ä¹°å…¥çš„${tokenType}ä»£å¸æ•°é‡:`);
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ï¼');
                return;
            }
            
            try {
                // æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€
                addTransaction(`åˆ›å»º${tokenType}ä¹°å•`, `æ•°é‡: ${amount}, çŠ¶æ€: å¤„ç†ä¸­...`);
                
                // çœŸå®çš„é“¾ä¸Šäº¤æ˜“
                const result = await executeRealTrade(market, tokenType, amount, 'buy');
                
                if (result.success) {
                    addTransaction(`ä¹°å…¥${tokenType}ä»£å¸`, `æ•°é‡: ${amount}, è®¢å•ID: ${result.orderId}, çŠ¶æ€: ${result.status}`);
                    alert(`æˆåŠŸåˆ›å»º${tokenType}ä¹°å•ï¼\næ•°é‡: ${amount}\nè®¢å•ID: ${result.orderId}\nçŠ¶æ€: ${result.status}\näº¤æ˜“å“ˆå¸Œ: ${result.txHash}`);
                    await updateUserBalance();
                    await loadMarkets(); // é‡æ–°åŠ è½½å¸‚åœºæ•°æ®
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addTransaction(`ä¹°å…¥${tokenType}ä»£å¸å¤±è´¥`, `é”™è¯¯: ${error.message}`);
                alert(`ä¹°å…¥å¤±è´¥: ${error.message}`);
            }
        }

        // å–å‡ºä»£å¸
        async function sellTokens(marketId, tokenType) {
            if (!currentUser) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
                return;
            }
            
            const market = markets.find(m => m.id === marketId);
            if (!market) {
                alert('å¸‚åœºä¸å­˜åœ¨ï¼');
                return;
            }
            
            const amount = prompt(`è¯·è¾“å…¥è¦å–å‡ºçš„${tokenType}ä»£å¸æ•°é‡:`);
            if (!amount || isNaN(amount) || amount <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡ï¼');
                return;
            }
            
            try {
                // æ˜¾ç¤ºäº¤æ˜“çŠ¶æ€
                addTransaction(`åˆ›å»º${tokenType}å–å•`, `æ•°é‡: ${amount}, çŠ¶æ€: å¤„ç†ä¸­...`);
                
                // çœŸå®çš„é“¾ä¸Šäº¤æ˜“
                const result = await executeRealTrade(market, tokenType, amount, 'sell');
                
                if (result.success) {
                    addTransaction(`å–å‡º${tokenType}ä»£å¸`, `æ•°é‡: ${amount}, è®¢å•ID: ${result.orderId}, çŠ¶æ€: ${result.status}`);
                    alert(`æˆåŠŸåˆ›å»º${tokenType}å–å•ï¼\næ•°é‡: ${amount}\nè®¢å•ID: ${result.orderId}\nçŠ¶æ€: ${result.status}\näº¤æ˜“å“ˆå¸Œ: ${result.txHash}`);
                    await updateUserBalance();
                    await loadMarkets(); // é‡æ–°åŠ è½½å¸‚åœºæ•°æ®
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                addTransaction(`å–å‡º${tokenType}ä»£å¸å¤±è´¥`, `é”™è¯¯: ${error.message}`);
                alert(`å–å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // æ‰§è¡ŒçœŸå®çš„é“¾ä¸Šäº¤æ˜“
        async function executeRealTrade(market, tokenType, amount, action) {
            try {
                if (!provider || !signer) {
                    throw new Error('é’±åŒ…æœªè¿æ¥');
                }

                // åˆçº¦åœ°å€
                const CTF_ADDRESS = '0x3338E58FAFfE71F89b2Bcb48384C9424c36060c6'; // OpenZeppelin ERC1155 CTF
                const EXCHANGE_ADDRESS = '0x666DDb461FDb5E10BF6329513D609615C069E489'; // CTF Exchange

                // è·å–ä»£å¸ID
                const tokenId = tokenType === 'YES' ? market.yesTokenId : market.noTokenId;
                const amountWei = ethers.parseUnits(amount.toString(), 0); // CTFä»£å¸é€šå¸¸æ˜¯0ä½å°æ•°

                if (action === 'buy') {
                    // ä¹°å…¥ï¼šåˆ›å»ºä¹°å•ï¼Œç­‰å¾…åŒ¹é…
                    console.log('åˆ›å»ºä¹°å•...', { 
                        user: currentUser, 
                        tokenId: tokenId, 
                        amount: amountWei.toString(),
                        tokenType: tokenType,
                        market: market.question
                    });
                    
                    try {
                        const requestData = {
                            userAddress: currentUser,
                            tokenId: tokenId,
                            amount: amount.toString(),
                            tokenType: tokenType,
                            marketId: market.id,
                            action: 'buy',
                            price: '0.5' // å›ºå®šä»·æ ¼ï¼Œå®é™…åº”è¯¥ä»å¸‚åœºè·å–
                        };
                        
                        console.log('å‘é€ä¹°å•è¯·æ±‚:', requestData);
                        
                        const response = await fetch('http://localhost:3001/api/create-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        
                        console.log('APIå“åº”çŠ¶æ€:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        console.log('APIå“åº”ç»“æœ:', result);
                        
                        if (result.success) {
                            return {
                                success: true,
                                txHash: result.transactionHash,
                                orderId: result.orderId,
                                status: result.status
                            };
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (apiError) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', apiError);
                        throw new Error('åˆ›å»ºä¹°å•å¤±è´¥: ' + apiError.message);
                    }

                } else if (action === 'sell') {
                    // å–å‡ºï¼šæ£€æŸ¥ä½™é¢ååˆ›å»ºå–å•
                    const ctfContract = new ethers.Contract(CTF_ADDRESS, [
                        'function balanceOf(address account, uint256 id) external view returns (uint256)'
                    ], provider);

                    // æ£€æŸ¥ä½™é¢
                    try {
                        const balance = await ctfContract.balanceOf(currentUser, tokenId);
                        if (balance < amountWei) {
                            throw new Error(`ä»£å¸ä½™é¢ä¸è¶³ï¼Œå½“å‰ä½™é¢: ${ethers.formatUnits(balance, 0)}`);
                        }
                        console.log('ä»£å¸ä½™é¢æ£€æŸ¥é€šè¿‡:', ethers.formatUnits(balance, 0));
                    } catch (error) {
                        console.log('ä½™é¢æ£€æŸ¥å¤±è´¥:', error.message);
                        throw new Error('æ— æ³•æ£€æŸ¥ä»£å¸ä½™é¢ï¼Œè¯·ç¡®ä¿ä»£å¸å­˜åœ¨');
                    }

                    // åˆ›å»ºå–å•
                    console.log('åˆ›å»ºå–å•...', { 
                        user: currentUser, 
                        tokenId: tokenId, 
                        amount: amountWei.toString(),
                        tokenType: tokenType,
                        market: market.question
                    });
                    
                    try {
                        const requestData = {
                            userAddress: currentUser,
                            tokenId: tokenId,
                            amount: amount.toString(),
                            tokenType: tokenType,
                            marketId: market.id,
                            action: 'sell',
                            price: '0.5' // å›ºå®šä»·æ ¼ï¼Œå®é™…åº”è¯¥ä»å¸‚åœºè·å–
                        };
                        
                        console.log('å‘é€å–å•è¯·æ±‚:', requestData);
                        
                        const response = await fetch('http://localhost:3001/api/create-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            return {
                                success: true,
                                txHash: result.transactionHash,
                                orderId: result.orderId,
                                status: result.status
                            };
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (apiError) {
                        console.error('APIè°ƒç”¨å¤±è´¥:', apiError);
                        throw new Error('åˆ›å»ºå–å•å¤±è´¥: ' + apiError.message);
                    }
                }

            } catch (error) {
                console.error('äº¤æ˜“æ‰§è¡Œå¤±è´¥:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // é¢†å–USDC
        async function claimUSDC() {
            if (!currentUser) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3001/api/claim-usdc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: currentUser })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`æˆåŠŸé¢†å–1000 USDCï¼\näº¤æ˜“å“ˆå¸Œ: ${result.transactionHash}`);
                    addTransaction('é¢†å–USDC', `1000 USDC -> ${currentUser.substring(0, 10)}...`);
                    await updateUserBalance();
                } else {
                    alert(`é¢†å–å¤±è´¥: ${result.message}`);
                }
            } catch (error) {
                alert(`é¢†å–å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–°ç”¨æˆ·ä½™é¢
        async function updateUserBalance() {
            if (!currentUser || !provider) return;
            
            try {
                // ä»é“¾ä¸Šè·å–çœŸå®çš„ä½™é¢
                const USDC_ADDRESS = '0xC1C68E532E3F2e1F40e6b5EBC9D6c5f8c5e803D6';
                const CTF_ADDRESS = '0x3338E58FAFfE71F89b2Bcb48384C9424c36060c6';
                
                // è·å–USDCä½™é¢
                const usdcContract = new ethers.Contract(USDC_ADDRESS, [
                    'function balanceOf(address account) external view returns (uint256)',
                    'function decimals() external view returns (uint8)'
                ], provider);
                
                let usdcFormatted = '0';
                try {
                    const usdcBalance = await usdcContract.balanceOf(currentUser);
                    const usdcDecimals = await usdcContract.decimals();
                    usdcFormatted = ethers.formatUnits(usdcBalance, usdcDecimals);
                    console.log('USDCä½™é¢æŸ¥è¯¢æˆåŠŸ:', usdcFormatted);
                } catch (error) {
                    console.log('USDCä½™é¢æŸ¥è¯¢å¤±è´¥:', error.message);
                    usdcFormatted = '0';
                }
                
                // è·å–CTFä»£å¸ä½™é¢ï¼ˆéœ€è¦éå†æ‰€æœ‰å¸‚åœºï¼‰
                let totalYES = 0;
                let totalNO = 0;
                
                const ctfContract = new ethers.Contract(CTF_ADDRESS, [
                    'function balanceOf(address account, uint256 id) external view returns (uint256)'
                ], provider);
                
                for (const market of markets) {
                    try {
                        const yesBalance = await ctfContract.balanceOf(currentUser, market.yesTokenId);
                        const noBalance = await ctfContract.balanceOf(currentUser, market.noTokenId);
                        totalYES += parseFloat(ethers.formatUnits(yesBalance, 0));
                        totalNO += parseFloat(ethers.formatUnits(noBalance, 0));
                    } catch (error) {
                        console.log(`è·å–å¸‚åœº ${market.question} ä½™é¢å¤±è´¥:`, error.message);
                    }
                }
                
                // æ›´æ–°UIæ˜¾ç¤ºï¼ˆå¦‚æœå…ƒç´ å­˜åœ¨ï¼‰
                const usdcElement = document.getElementById('userUSDCBalance');
                const yesElement = document.getElementById('userYESBalance');
                const noElement = document.getElementById('userNOBalance');
                
                if (usdcElement) usdcElement.textContent = parseFloat(usdcFormatted).toFixed(2);
                if (yesElement) yesElement.textContent = totalYES.toString();
                if (noElement) noElement.textContent = totalNO.toString();
                
            } catch (error) {
                console.error('æ›´æ–°ä½™é¢å¤±è´¥:', error);
                // é™çº§åˆ°APIæŸ¥è¯¢
                try {
                    const response = await fetch(`http://localhost:3001/api/balance/${currentUser}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        const usdcElement = document.getElementById('userUSDCBalance');
                        if (usdcElement) usdcElement.textContent = result.balance;
                    }
                } catch (apiError) {
                    console.error('APIæŸ¥è¯¢ä½™é¢ä¹Ÿå¤±è´¥:', apiError);
                }
            }
        }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(action, details) {
            const transactionList = document.getElementById('transactionList');
            const transactionItem = document.createElement('div');
            transactionItem.className = 'transaction-item';
            transactionItem.innerHTML = `
                <strong>${action}</strong>: ${details}
                <br><small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
            `;
            transactionList.insertBefore(transactionItem, transactionList.firstChild);
            
            // é™åˆ¶æ˜¾ç¤ºæœ€è¿‘20æ¡è®°å½•
            while (transactionList.children.length > 20) {
                transactionList.removeChild(transactionList.lastChild);
            }
        }
    </script>
</body>
</html>
